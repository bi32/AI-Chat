<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with Shizuku</title>
    <link rel="icon" href="data:,">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=ZCOOL+XiaoWei&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'ZCOOL XiaoWei', 'Noto Sans SC', sans-serif;
            overflow: hidden;
            position: relative;
            height: 100vh;
            background: linear-gradient(135deg, #e6f2ff 0%, #cce5ff 100%);
            font-size: 18px;
        }
        
        /* åŠ¨ç”»èƒŒæ™¯ */
        .animated-bg {
            position: fixed;
            top: 0;
            left: -85px;
            width: calc(100% + 170px);
            height: 100%;
            background: repeating-linear-gradient(
                45deg,
                #cce5ff,
                #cce5ff 30px,
                #e6f2ff 30px,
                #e6f2ff 60px
            );
            animation: slideRight 3s linear infinite;
            z-index: -2;
        }
        
        @keyframes slideRight {
            0% {
                transform: translateX(0);
            }
            100% {
                transform: translateX(84.853px);
            }
        }
        
        /* èŠå¤©å®¹å™¨ */
        .chat-container {
            position: absolute;
            left: calc(55% + 100px);
            top: 50%;
            transform: translate(-50%, -50%);
            width: 85%;
            max-width: 650px;
            height: 80vh;
            background: linear-gradient(135deg, rgba(255, 240, 245, 0.95) 0%, rgba(255, 220, 235, 0.95) 100%);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3), 0 0 120px rgba(255, 182, 193, 0.4);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            filter: url('#sketch-border');
        }
        
        /* èŠå¤©å¤´éƒ¨ */
        .chat-header {
            background: linear-gradient(135deg, #ff91a4 0%, #ffa0b4 50%, #ffb1c1 100%);
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 28px;
            font-weight: 700;
            letter-spacing: 2px;
        }
        
        /* æ¶ˆæ¯åŒºåŸŸ */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.5);
        }
        
        /* æ¶ˆæ¯æ ·å¼ */
        .message {
            margin-bottom: 15px;
            animation: fadeIn 0.3s ease-out;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.user {
            text-align: right;
            flex-direction: row-reverse;
        }
        
        .message.ai {
            text-align: left;
            flex-direction: row;
        }
        
        /* AIå¤´åƒ */
        .ai-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
            background: white;
            padding: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15), 0 0 15px rgba(0, 0, 0, 0.1);
            border: 3px solid #333;
            align-self: flex-start;
            margin-top: 0;
            position: relative;
        }
        
        /* ç”¨æˆ·å¤´åƒ */
        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
            background: white;
            padding: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15), 0 0 15px rgba(0, 0, 0, 0.1);
            border: 3px solid #7b8cef;
            align-self: flex-start;
            margin-top: 0;
            position: relative;
        }
        
        .ai-avatar img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .user-avatar img {
            width: 130%;
            height: 130%;
            object-fit: cover;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .ai-avatar.rotating img {
            animation: rotate 2s linear infinite;
        }
        
        .ai-avatar.stopping img {
            animation: rotateToOriginal 1s ease-out forwards;
        }
        
        @keyframes rotate {
            from {
                transform: translate(-50%, -50%) rotate(0deg);
            }
            to {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }
        
        @keyframes rotateToOriginal {
            from {
                transform: translate(-50%, -50%) rotate(var(--current-rotation));
            }
            to {
                transform: translate(-50%, -50%) rotate(calc(var(--current-rotation) + var(--rotation-diff)));
            }
        }
        
        .message-bubble {
            display: inline-block;
            max-width: 70%;
            padding: 12px 18px;
            border-radius: 18px;
            word-wrap: break-word;
            position: relative;
            filter: url('#sketch-border');
        }
        
        .user .message-bubble {
            background: linear-gradient(135deg, #7b8cef 0%, #947eb9 100%);
            color: white;
            border-bottom-right-radius: 4px;
            box-shadow: 0 5px 15px rgba(139, 156, 255, 0.4), 0 0 25px rgba(164, 142, 201, 0.3);
        }
        
        .ai .message-bubble {
            background: white;
            color: #333;
            border: 2px solid #f8b5d6;
            border-bottom-left-radius: 4px;
            box-shadow: 0 5px 15px rgba(248, 181, 214, 0.4), 0 0 25px rgba(255, 182, 193, 0.3);
        }
        
        .typing-indicator {
            display: inline-block;
            padding: 12px 18px;
        }
        
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #764ba2;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }
        
        /* è¾“å…¥åŒºåŸŸ */
        .input-container {
            padding: 20px;
            background: white;
            border-top: 2px solid #f0f0f0;
            display: flex;
            gap: 10px;
        }
        
        .message-input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 18px;
            outline: none;
            transition: border-color 0.3s;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .message-input:focus {
            border-color: #764ba2;
        }
        
        .send-button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #7b8cef 0%, #947eb9 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 4px 15px rgba(139, 156, 255, 0.3);
        }
        
        .send-button:hover {
            transform: scale(1.05);
        }
        
        .send-button:active {
            transform: scale(0.95);
        }
        
        /* æ‰‹ç»˜æ•ˆæœ */
        svg {
            position: absolute;
            width: 0;
            height: 0;
        }
        
        /* Tokenè®¡æ•°å™¨ */
        .token-counter {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 15px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15), 0 0 20px rgba(255, 105, 180, 0.2);
            font-size: 15px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 10000;
            border: 2px solid #ff905d;
            min-width: 120px;
            filter: url('#sketch-border');
        }
        
        .token-counter::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #ff905d;
            border-radius: 15px;
            z-index: -1;
            filter: url('#sketch-border');
        }
        
        .token-counter span {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #333;
            font-weight: 600;
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        .messages-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .messages-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }
        
        .messages-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #7b8cef 0%, #947eb9 100%);
            border-radius: 4px;
        }
        
        /* å¯¹è¯æ°”æ³¡ */
        .chat-bubble {
            position: fixed;
            left: 410px;
            top: calc(50% - 380px);
            background: rgba(255, 255, 255, 0.95);
            border: 3px solid #ff69b4;
            border-radius: 20px;
            padding: 15px 20px;
            font-size: 20px;
            font-family: 'ZCOOL XiaoWei', sans-serif;
            color: #333;
            opacity: 0;
            transform: scale(0.8) translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: none;
            z-index: 10000;
            max-width: 250px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2), 0 0 30px rgba(255, 105, 180, 0.3);
            filter: url('#sketch-border');
        }
        
        .chat-bubble::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 3px solid #ff69b4;
            border-radius: 20px;
            z-index: -1;
            filter: url('#sketch-border');
        }
        
        .chat-bubble.show {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
        
        .chat-bubble-arrow {
            position: absolute;
            bottom: -10px;
            left: 20px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid #ff69b4;
        }
        
        .chat-bubble-arrow::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: -10px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid rgba(255, 255, 255, 0.95);
        }
        
        /* å…¨å±ç‰¹æ•ˆå®¹å™¨ */
        .effects-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }
        
        /* ç‰¹æ•ˆç²’å­åŸºç¡€æ ·å¼ */
        .effect-particle {
            position: absolute;
            pointer-events: none;
            font-size: 30px;
            animation-fill-mode: forwards;
        }
        
        /* ä¸‹è½åŠ¨ç”» */
        @keyframes fall {
            0% {
                opacity: 0;
                transform: translateY(0) rotate(0deg);
            }
            5% {
                opacity: 1;
            }
            50% {
                opacity: 1;
                transform: translateY(50vh) rotate(180deg);
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <!-- SVG æ»¤é•œå®šä¹‰ -->
    <svg>
        <defs>
            <filter id="handDrawn">
                <feTurbulence type="turbulence" baseFrequency="0.02" numOctaves="3" result="turbulence" seed="1" />
                <feDisplacementMap in="SourceGraphic" in2="turbulence" scale="2" />
            </filter>
            <filter id="sketch">
                <feTurbulence type="turbulence" baseFrequency="0.02" numOctaves="2" result="noise" seed="5" />
                <feDisplacementMap in="SourceGraphic" in2="noise" scale="3" />
                <feComponentTransfer>
                    <feFuncA type="discrete" tableValues="0 .5 .5 .5 1" />
                </feComponentTransfer>
            </filter>
            <filter id="sketch-border">
                <feTurbulence type="turbulence" baseFrequency="0.02" numOctaves="2" result="noise" seed="5" />
                <feDisplacementMap in="SourceGraphic" in2="noise" scale="2" />
            </filter>
        </defs>
    </svg>
    
    <!-- åŠ¨ç”»èƒŒæ™¯ -->
    <div class="animated-bg"></div>
    
    <!-- å…¨å±ç‰¹æ•ˆå®¹å™¨ -->
    <div class="effects-container" id="effectsContainer"></div>
    
    <!-- å¯¹è¯æ°”æ³¡ -->
    <div class="chat-bubble" id="chatBubble">
        <div class="chat-bubble-arrow"></div>
    </div>
    
    <!-- Tokenè®¡æ•°å™¨ -->
    <div class="token-counter" id="tokenCounter">
        <span>â†—ï¸&nbsp;&nbsp;<span id="inputTokens">0</span> tokens</span>
        <span>â†™ï¸&nbsp;&nbsp;<span id="outputTokens">0</span> tokens</span>
    </div>
    
    <!-- èŠå¤©å®¹å™¨ -->
    <div class="chat-container">
        <div class="chat-header">
            AI Chat with Shizuku
        </div>
        
        <div class="messages-container" id="messagesContainer">
            <!-- åˆå§‹æ¬¢è¿æ¶ˆæ¯ -->
            <div class="message ai">
                <div class="ai-avatar">
                    <img src="ollama.png" alt="AI">
                </div>
                <div class="message-bubble">
                    å“¼~ ä½ ç»ˆäºæ¥äº†å•Šï¼Œç¬¨è›‹ï¼æˆ‘...æˆ‘æ‰ä¸æ˜¯åœ¨ç­‰ä½ å‘¢ï¼åªæ˜¯åˆšå¥½åœ¨è¿™é‡Œè€Œå·²... (ï½¡â€¢Ìï¸¿â€¢Ì€ï½¡)
                </div>
            </div>
        </div>
        
        <div class="input-container">
            <input 
                type="text" 
                class="message-input" 
                id="messageInput" 
                placeholder="è¾“å…¥æ¶ˆæ¯..." 
                onkeypress="handleKeyPress(event)"
            >
            <button class="send-button" onclick="sendMessage()">å‘é€</button>
        </div>
    </div>
    
    <!-- Live2D Widget -->
    <script src="https://cdn.jsdelivr.net/npm/live2d-widget@3.1.4/lib/L2Dwidget.min.js"></script>
    <script>
        // åˆå§‹åŒ– Live2D - ä½¿ç”¨ Shizuku
        L2Dwidget.init({
            pluginRootPath: 'https://cdn.jsdelivr.net/npm/live2d-widget@3.1.4/',
            pluginJsPath: 'lib/',
            pluginModelPath: 'assets/',
            tagMode: false,
            debug: false,
            model: {
                jsonPath: 'https://cdn.jsdelivr.net/npm/live2d-widget-model-shizuku@1.0.5/assets/shizuku.model.json',
                scale: 0.5
            },
            display: {
                position: 'left',
                width: 900,
                height: 900,
                hOffset: 100,
                vOffset: 0
            },
            mobile: {
                show: true,
                scale: 0.8
            },
            react: {
                opacityDefault: 0.9,
                opacityOnHover: 0.2
            }
        });
        
        // æƒ…ç»ªå¯¹è¯åˆ—è¡¨
        let cuteMessages = [];
        let randomEmotions = [];
        
        // åŠ è½½æƒ…ç»ªæ–‡æœ¬
        async function loadEmotions() {
            try {
                const response = await fetch('/api/emotions');
                const text = await response.text();
                const allEmotions = text.split('\n').filter(line => line.trim());
                
                // éšæœºåˆ†é…åˆ°ä¸¤ä¸ªæ•°ç»„
                allEmotions.forEach(emotion => {
                    if (Math.random() < 0.5) {
                        cuteMessages.push(emotion);
                    } else {
                        randomEmotions.push(emotion);
                    }
                });
                
                // ç¡®ä¿ä¸¤ä¸ªæ•°ç»„éƒ½æœ‰å†…å®¹
                if (cuteMessages.length === 0) cuteMessages = allEmotions.slice(0, Math.floor(allEmotions.length / 2));
                if (randomEmotions.length === 0) randomEmotions = allEmotions.slice(Math.floor(allEmotions.length / 2));
                
                console.log(`Loaded ${cuteMessages.length} cute messages and ${randomEmotions.length} random emotions`);
            } catch (error) {
                console.error('Failed to load emotions:', error);
                // ä½¿ç”¨é»˜è®¤å€¼
                cuteMessages = ["å“¼ï¼Œåˆ«æˆ³æˆ‘å•¦ï¼å¾ˆç—’çš„... (ï½¡ï½¥Ï‰ï½¥ï½¡)ğŸ’•", "ç¬¨è›‹ï¼æœ‰ä»€ä¹ˆæƒ³é—®çš„å°±å¿«è¯´å•Šï¼ğŸ˜¤"];
                randomEmotions = ["å‘œå“‡...å¥½æƒ³åƒè‰è“è›‹ç³•... ğŸ° æ‰ä¸æ˜¯å˜´é¦‹å‘¢ï¼", "ä»Šå¤©çš„å¤©æ°”çœŸå¥½å‘¢~ â˜€ï¸"];
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åŠ è½½æƒ…ç»ª
        loadEmotions();
        
        let messageTimeout;
        let isTyping = false;
        let totalInputTokens = 0;
        let totalOutputTokens = 0;
        let emotionInterval;
        let lonelyTimeout;
        let lastInteractionTime = Date.now();
        let chatHistory = [];
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶åˆ° Live2D
        setTimeout(() => {
            // ä¸ºLive2Dåˆ›å»ºä¸€ä¸ªæ­£ç¡®å®šä½çš„ç‚¹å‡»åŒºåŸŸ
            const clickArea = document.createElement('div');
            clickArea.style.cssText = `
                position: fixed;
                left: 0;
                top: 0;
                width: 800px;
                height: 100vh;
                z-index: 999;
                cursor: pointer;
            `;
            clickArea.addEventListener('click', (e) => {
                e.stopPropagation();
                showCuteMessage();
                // è§¦å‘Live2DåŠ¨ä½œ
                triggerLive2DAction();
            });
            document.body.appendChild(clickArea);
            
            // åŒæ—¶ç»™canvasæ·»åŠ æ ·å¼
            const live2dCanvas = document.querySelector('#live2d');
            if (live2dCanvas) {
                live2dCanvas.style.pointerEvents = 'none';
            }
            
            // å¯åŠ¨éšæœºåŠ¨ä½œ
            startRandomActions();
        }, 3000);
        
        // è§¦å‘Live2DåŠ¨ä½œ
        function triggerLive2DAction() {
            const canvas = document.querySelector('#live2d');
            if (canvas) {
                // æ¨¡æ‹Ÿä¸åŒä½ç½®çš„ç‚¹å‡»ä»¥è§¦å‘ä¸åŒåŠ¨ä½œ
                const positions = [
                    { x: canvas.width * 0.5, y: canvas.height * 0.3 }, // å¤´éƒ¨
                    { x: canvas.width * 0.5, y: canvas.height * 0.5 }, // èº«ä½“
                    { x: canvas.width * 0.3, y: canvas.height * 0.6 }, // å·¦ä¾§
                    { x: canvas.width * 0.7, y: canvas.height * 0.6 }  // å³ä¾§
                ];
                const pos = positions[Math.floor(Math.random() * positions.length)];
                
                // åˆ›å»ºå¹¶è§¦å‘ç‚¹å‡»äº‹ä»¶
                const event = new MouseEvent('click', {
                    view: window,
                    bubbles: true,
                    cancelable: true,
                    clientX: canvas.offsetLeft + pos.x,
                    clientY: canvas.offsetTop + pos.y
                });
                canvas.dispatchEvent(event);
            }
        }
        
        // å¯åŠ¨éšæœºåŠ¨ä½œ
        function startRandomActions() {
            // æ¯15-30ç§’è§¦å‘ä¸€æ¬¡éšæœºåŠ¨ä½œ
            setInterval(() => {
                if (!isTyping && Math.random() < 0.4) { // 40%æ¦‚ç‡
                    triggerLive2DAction();
                }
            }, 15000 + Math.random() * 15000);
        }
        
        // ç‰¹æ•ˆè§¦å‘å…³é”®è¯æ˜ å°„
        const effectKeywords = {
            birthday: {
                keywords: ['ç”Ÿæ—¥', 'ç”Ÿæ—¥å¿«ä¹', 'birthday', 'happy birthday'],
                emojis: ['ğŸ‚', 'ğŸˆ', 'ğŸ‰', 'ğŸŠ', 'ğŸ'],
                animation: 'fall',
                duration: 8000
            },
            congrats: {
                keywords: ['æ­å–œ', 'ç¥è´º', 'å¤ªæ£’äº†', '666', 'ç‰›', 'å‰å®³', 'èµ', 'ä¼˜ç§€'],
                emojis: ['ğŸŠ', 'âœ¨', 'â­', 'ğŸ‘', 'ğŸ’¯'],
                animation: 'fall',
                duration: 8000
            },
            fireworks: {
                keywords: ['çƒŸèŠ±', 'æ”¾çƒŸèŠ±', 'æ–°å¹´', 'è¿‡å¹´', 'fireworks'],
                emojis: ['ğŸ†', 'ğŸ‡', 'âœ¨'],
                animation: 'fall',
                duration: 8000
            },
            love: {
                keywords: ['çˆ±ä½ ', 'ä¹ˆä¹ˆå“’', 'äº²äº²', 'çˆ±', 'love', 'â¤ï¸', 'ğŸ’•'],
                emojis: ['â¤ï¸', 'ğŸ’•', 'ğŸ˜˜', 'ğŸ’–', 'ğŸ’—'],
                animation: 'fall',
                duration: 8000
            },
            cry: {
                keywords: ['å“­', 'å‘œå‘œ', 'éš¾è¿‡', 'ä¼¤å¿ƒ', 'æµæ³ª', 'ğŸ˜­'],
                emojis: ['ğŸ˜­', 'ğŸ’§', 'ğŸ˜¢', 'ğŸ˜¥'],
                animation: 'fall',
                duration: 8000
            },
            angry: {
                keywords: ['ç”Ÿæ°”', 'æ°”æ­»äº†', 'æ„¤æ€’', 'ç«å¤§', 'ğŸ˜¤', 'ğŸ’¢'],
                emojis: ['ğŸ˜¤', 'ğŸ’¢', 'ğŸ˜¡', 'ğŸ”¥'],
                animation: 'fall',
                duration: 8000
            },
            sick: {
                keywords: ['æ¶å¿ƒ', 'å‘•', 'å', 'æƒ³å', 'ğŸ¤®'],
                emojis: ['ğŸ¤®', 'ğŸ¤¢', 'ğŸ˜µâ€ğŸ’«'],
                animation: 'fall',
                duration: 8000
            },
            poop: {
                keywords: ['å±', 'æ‹‰å±', 'ä¾¿ä¾¿', 'ğŸ’©', 'poop'],
                emojis: ['ğŸ’©'],
                animation: 'fall',
                duration: 8000
            },
            explode: {
                keywords: ['çˆ†ç‚¸', 'boom', 'ç‚¸äº†', 'ğŸ’¥'],
                emojis: ['ğŸ’¥', 'ğŸ”¥', 'ğŸ’£'],
                animation: 'fall',
                duration: 8000
            },
            money: {
                keywords: ['é’±', 'å‘è´¢', 'çº¢åŒ…', 'æš´å¯Œ', 'ğŸ’°'],
                emojis: ['ğŸ’°', 'ğŸ’µ', 'ğŸ’´', 'ğŸ’¶', 'ğŸ’·', 'ğŸ§§'],
                animation: 'fall',
                duration: 8000
            },
            music: {
                keywords: ['éŸ³ä¹', 'å”±æ­Œ', 'éŸ³ç¬¦', 'ğŸµ'],
                emojis: ['ğŸµ', 'ğŸ¶', 'ğŸ¼', 'ğŸ¤'],
                animation: 'fall',
                duration: 8000
            },
            laugh: {
                keywords: ['å“ˆå“ˆ', 'ç¬‘æ­»', 'å¼€å¿ƒ', 'å¿«ä¹', 'ğŸ˜‚', 'ğŸ¤£'],
                emojis: ['ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜„', 'ğŸ˜†'],
                animation: 'fall',
                duration: 8000
            },
            cheer: {
                keywords: ['åŠ æ²¹', 'å†²', 'fighting', 'ğŸ’ª'],
                emojis: ['ğŸ’ª', 'ğŸ”¥', 'âš¡', 'ğŸš€'],
                animation: 'fall',
                duration: 8000
            },
            applause: {
                keywords: ['é¼“æŒ', 'æŒå£°', 'ğŸ‘'],
                emojis: ['ğŸ‘', 'âœ¨'],
                animation: 'fall',
                duration: 8000
            },
            rain: {
                keywords: ['ä¸‹é›¨', 'é›¨', 'â˜”'],
                emojis: ['ğŸŒ§ï¸', 'â˜”', 'ğŸ’§'],
                animation: 'fall',
                duration: 8000
            },
            snow: {
                keywords: ['ä¸‹é›ª', 'é›ªèŠ±', 'é›ª', 'â„ï¸'],
                emojis: ['â„ï¸', 'â›„', 'ğŸŒ¨ï¸'],
                animation: 'fall',
                duration: 8000
            }
        };
        
        // æœ€è¿‘è§¦å‘æ—¶é—´è®°å½•
        const lastEffectTime = {};
        
        // æ£€æŸ¥å¹¶è§¦å‘ç‰¹æ•ˆ
        function checkAndTriggerEffect(text) {
            const now = Date.now();
            
            for (const [effectName, config] of Object.entries(effectKeywords)) {
                // æ£€æŸ¥æ˜¯å¦åœ¨å†·å´æ—¶é—´å†…ï¼ˆ10ç§’ï¼‰
                if (lastEffectTime[effectName] && now - lastEffectTime[effectName] < 10000) {
                    continue;
                }
                
                // æ£€æŸ¥å…³é”®è¯
                const hasKeyword = config.keywords.some(keyword => 
                    text.toLowerCase().includes(keyword.toLowerCase())
                );
                
                if (hasKeyword) {
                    lastEffectTime[effectName] = now;
                    triggerEffect(effectName, config);
                    break; // ä¸€æ¬¡åªè§¦å‘ä¸€ä¸ªç‰¹æ•ˆ
                }
            }
        }
        
        // è§¦å‘ç‰¹æ•ˆ
        function triggerEffect(effectName, config) {
            const container = document.getElementById('effectsContainer');
            container.innerHTML = ''; // æ¸…é™¤ä¹‹å‰çš„ç‰¹æ•ˆ
            
            // åªä½¿ç”¨ä¸‹è½æ•ˆæœ
            createFallingEffect(config.emojis, config.duration);
        }
        
        // åˆ›å»ºä¸‹è½ç‰¹æ•ˆ
        function createFallingEffect(emojis, duration) {
            const container = document.getElementById('effectsContainer');
            const particleCount = 30;
            
            for (let i = 0; i < particleCount; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = 'effect-particle';
                    particle.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.top = '-50px';
                    particle.style.fontSize = (20 + Math.random() * 20) + 'px';
                    particle.style.animation = `fall 8s linear`;
                    
                    container.appendChild(particle);
                    
                    particle.addEventListener('animationend', () => particle.remove());
                }, i * 100);
            }
            
            setTimeout(() => container.innerHTML = '', duration);
        }
        
        // æ˜¾ç¤ºå¯çˆ±å¯¹è¯
        function showCuteMessage() {
            const bubble = document.getElementById('chatBubble');
            const randomMessage = cuteMessages[Math.floor(Math.random() * cuteMessages.length)];
            
            // æ›´æ–°å†…å®¹ï¼Œä½†ä¿ç•™ç®­å¤´
            const arrow = bubble.querySelector('.chat-bubble-arrow');
            bubble.childNodes.forEach(node => {
                if (node.nodeType === Node.TEXT_NODE || (node.nodeType === Node.ELEMENT_NODE && !node.classList.contains('chat-bubble-arrow'))) {
                    node.remove();
                }
            });
            bubble.insertAdjacentText('afterbegin', randomMessage);
            bubble.classList.add('show');
            
            if (messageTimeout) {
                clearTimeout(messageTimeout);
            }
            
            messageTimeout = setTimeout(() => {
                bubble.classList.remove('show');
            }, 6000);
        }
        
        // æ˜¾ç¤ºéšæœºæƒ…ç»ª
        function showRandomEmotion() {
            if (randomEmotions.length === 0) return;
            
            const bubble = document.getElementById('chatBubble');
            const randomMessage = randomEmotions[Math.floor(Math.random() * randomEmotions.length)];
            
            // æ›´æ–°å†…å®¹ï¼Œä½†ä¿ç•™ç®­å¤´
            const arrow = bubble.querySelector('.chat-bubble-arrow');
            bubble.childNodes.forEach(node => {
                if (node.nodeType === Node.TEXT_NODE || (node.nodeType === Node.ELEMENT_NODE && !node.classList.contains('chat-bubble-arrow'))) {
                    node.remove();
                }
            });
            bubble.insertAdjacentText('afterbegin', randomMessage);
            bubble.classList.add('show');
            
            if (messageTimeout) {
                clearTimeout(messageTimeout);
            }
            
            messageTimeout = setTimeout(() => {
                bubble.classList.remove('show');
            }, 6000);
        }
        
        // å¯åŠ¨éšæœºæƒ…ç»ªæ˜¾ç¤º
        setTimeout(() => {
            emotionInterval = setInterval(() => {
                if (!isTyping && Math.random() < 0.3) { // 30%æ¦‚ç‡æ˜¾ç¤º
                    showRandomEmotion();
                }
            }, 15000); // æ¯15ç§’æ£€æŸ¥ä¸€æ¬¡
        }, 5000); // 5ç§’åå¼€å§‹
        
        // å¤„ç†é”®ç›˜äº‹ä»¶
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || isTyping) return;
            
            // æ›´æ–°æœ€åäº¤äº’æ—¶é—´
            lastInteractionTime = Date.now();
            resetLonelyTimer();
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = '';
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage(message, 'user');
            
            // æ£€æŸ¥å¹¶è§¦å‘ç‰¹æ•ˆ
            checkAndTriggerEffect(message);
            
            // è§¦å‘Live2DåŠ¨ä½œ
            triggerLive2DAction();
            
            // æ›´æ–°è¾“å…¥tokenæ•°ï¼ˆç®€å•ä¼°ç®—ï¼šæ¯4ä¸ªå­—ç¬¦çº¦1ä¸ªtokenï¼‰
            totalInputTokens += Math.ceil(message.length / 4);
            updateTokenDisplay();
            
            // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥
            showTypingIndicator();
            isTyping = true;
            
            // æ·»åŠ åˆ°å†å²è®°å½•
            chatHistory.push({ role: 'user', content: message });
            
            // ä¿æŒæœ€è¿‘20è½®å¯¹è¯
            if (chatHistory.length > 40) { // 40æ¡æ¶ˆæ¯ = 20è½®å¯¹è¯
                chatHistory = chatHistory.slice(-40);
            }
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        message,
                        history: chatHistory.slice(0, -1) // ä¸åŒ…å«åˆšåˆšæ·»åŠ çš„ç”¨æˆ·æ¶ˆæ¯
                    })
                });
                
                if (!response.ok) {
                    throw new Error('è¯·æ±‚å¤±è´¥');
                }
                
                // åˆ›å»º EventSource æ¥æ¥æ”¶æµå¼å“åº”
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let aiMessage = '';
                let messageDiv = null;
                
                hideTypingIndicator();
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) {
                        // å®Œæˆåæ›´æ–°è¾“å‡ºtokenæ€»æ•°
                        if (aiMessage) {
                            totalOutputTokens += Math.ceil(aiMessage.length / 4);
                            updateTokenDisplay();
                            
                            // æ·»åŠ AIå›å¤åˆ°å†å²è®°å½•
                            chatHistory.push({ role: 'assistant', content: aiMessage });
                            
                            // æ£€æŸ¥AIå›å¤ä¸­çš„ç‰¹æ•ˆå…³é”®è¯
                            checkAndTriggerEffect(aiMessage);
                        }
                        
                        // æ—‹è½¬åˆ°åŸä½ååœæ­¢
                        if (messageDiv && messageDiv.avatarDiv) {
                            const img = messageDiv.avatarDiv.querySelector('img');
                            if (img) {
                                // è·å–å½“å‰æ—‹è½¬è§’åº¦
                                const computedStyle = window.getComputedStyle(img);
                                const transform = computedStyle.transform;
                                let currentRotation = 0;
                                if (transform && transform !== 'none') {
                                    const values = transform.split('(')[1].split(')')[0].split(',');
                                    const a = values[0];
                                    const b = values[1];
                                    currentRotation = Math.atan2(b, a) * (180 / Math.PI);
                                }
                                
                                // è®¡ç®—éœ€è¦æ—‹è½¬çš„è§’åº¦ä»¥è¾¾åˆ°æœ€è¿‘çš„360åº¦å€æ•°
                                if (currentRotation < 0) currentRotation += 360;
                                const rotationDiff = 360 - (currentRotation % 360);
                                
                                // è®¾ç½® CSS å˜é‡
                                img.style.setProperty('--current-rotation', currentRotation + 'deg');
                                img.style.setProperty('--rotation-diff', rotationDiff + 'deg');
                                messageDiv.avatarDiv.classList.remove('rotating');
                                messageDiv.avatarDiv.classList.add('stopping');
                                
                                // åŠ¨ç”»ç»“æŸåç§»é™¤stoppingç±»
                                setTimeout(() => {
                                    messageDiv.avatarDiv.classList.remove('stopping');
                                    img.style.transform = 'translate(-50%, -50%) rotate(0deg)';
                                }, 1000);
                            }
                        }
                        break;
                    }
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (data.content) {
                                    aiMessage += data.content;
                                    if (!messageDiv) {
                                        messageDiv = addMessage(aiMessage, 'ai');
                                        // AIå¼€å§‹å›å¤æ—¶è§¦å‘åŠ¨ä½œ
                                        triggerLive2DAction();
                                    } else {
                                        updateMessage(messageDiv, aiMessage);
                                    }
                                }
                                if (data.done) {
                                    // å®Œæˆåæ›´æ–°è¾“å‡ºtokenæ€»æ•°
                                    if (aiMessage) {
                                        totalOutputTokens += Math.ceil(aiMessage.length / 4);
                                        updateTokenDisplay();
                                        
                                        // æ·»åŠ AIå›å¤åˆ°å†å²è®°å½•
                                        chatHistory.push({ role: 'assistant', content: aiMessage });
                                        
                                        // æ£€æŸ¥AIå›å¤ä¸­çš„ç‰¹æ•ˆå…³é”®è¯
                                        checkAndTriggerEffect(aiMessage);
                                    }
                                    
                                    // æ—‹è½¬åˆ°åŸä½ååœæ­¢
                                    if (messageDiv && messageDiv.avatarDiv) {
                                        const img = messageDiv.avatarDiv.querySelector('img');
                                        if (img) {
                                            // è·å–å½“å‰æ—‹è½¬è§’åº¦
                                            const computedStyle = window.getComputedStyle(img);
                                            const transform = computedStyle.transform;
                                            let currentRotation = 0;
                                            if (transform && transform !== 'none') {
                                                const values = transform.split('(')[1].split(')')[0].split(',');
                                                const a = values[0];
                                                const b = values[1];
                                                currentRotation = Math.atan2(b, a) * (180 / Math.PI);
                                            }
                                            
                                            // è®¡ç®—éœ€è¦æ—‹è½¬çš„è§’åº¦ä»¥è¾¾åˆ°æœ€è¿‘çš„360åº¦å€æ•°
                                            if (currentRotation < 0) currentRotation += 360;
                                            const rotationDiff = 360 - (currentRotation % 360);
                                            
                                            // è®¾ç½® CSS å˜é‡
                                            img.style.setProperty('--current-rotation', currentRotation + 'deg');
                                            img.style.setProperty('--rotation-diff', rotationDiff + 'deg');
                                            messageDiv.avatarDiv.classList.remove('rotating');
                                            messageDiv.avatarDiv.classList.add('stopping');
                                            
                                            // åŠ¨ç”»ç»“æŸåç§»é™¤stoppingç±»
                                            setTimeout(() => {
                                                messageDiv.avatarDiv.classList.remove('stopping');
                                                img.style.transform = 'translate(-50%, -50%) rotate(0deg)';
                                            }, 1000);
                                        }
                                    }
                                }
                            } catch (e) {
                                // å¿½ç•¥è§£æé”™è¯¯
                            }
                        }
                    }
                }
                
            } catch (error) {
                hideTypingIndicator();
                addMessage('å“¼ï¼å‡ºé”™äº†...ä½†è¿™ä¸æ˜¯æˆ‘çš„é”™ï¼æ˜¯æœåŠ¡å™¨çš„é—®é¢˜å•¦ï¼(ï½¡â€¢Ìï¸¿â€¢Ì€ï½¡)', 'ai');
            } finally {
                isTyping = false;
            }
        }
        
        // æ·»åŠ æ¶ˆæ¯
        function addMessage(text, sender) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            if (sender === 'ai') {
                // æ·»åŠ AIå¤´åƒ
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'ai-avatar rotating';
                const avatarImg = document.createElement('img');
                avatarImg.src = 'ollama.png';
                avatarImg.alt = 'AI';
                avatarDiv.appendChild(avatarImg);
                messageDiv.appendChild(avatarDiv);
                
                // å­˜å‚¨å¤´åƒå¼•ç”¨ä»¥ä¾¿åç»­åœæ­¢æ—‹è½¬
                messageDiv.avatarDiv = avatarDiv;
            } else if (sender === 'user') {
                // æ·»åŠ ç”¨æˆ·å¤´åƒ
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'user-avatar';
                const avatarImg = document.createElement('img');
                avatarImg.src = 'ollama_user.png';
                avatarImg.alt = 'User';
                avatarDiv.appendChild(avatarImg);
                messageDiv.appendChild(avatarDiv);
            }
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';
            bubbleDiv.textContent = text;
            
            messageDiv.appendChild(bubbleDiv);
            messagesContainer.appendChild(messageDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return messageDiv;
        }
        
        // æ›´æ–°æ¶ˆæ¯å†…å®¹
        function updateMessage(messageDiv, text) {
            const bubble = messageDiv.querySelector('.message-bubble');
            if (bubble) {
                bubble.textContent = text;
            }
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
        function showTypingIndicator() {
            const messagesContainer = document.getElementById('messagesContainer');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ai';
            typingDiv.id = 'typingIndicator';
            
            const indicatorDiv = document.createElement('div');
            indicatorDiv.className = 'typing-indicator';
            indicatorDiv.innerHTML = '<span></span><span></span><span></span>';
            
            typingDiv.appendChild(indicatorDiv);
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // éšè—æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }
        
        // æ›´æ–°Tokenæ˜¾ç¤º
        function updateTokenDisplay() {
            document.getElementById('inputTokens').textContent = totalInputTokens;
            document.getElementById('outputTokens').textContent = totalOutputTokens;
        }
        
        // å­¤ç‹¬æ¶ˆæ¯åˆ—è¡¨
        const lonelyMessages = [
            "å–‚...ä½ è¿˜åœ¨å—ï¼Ÿæ˜¯ä¸æ˜¯ä¸å–œæ¬¢æˆ‘äº†... (Â´ï½¥Ï‰ï½¥`)",
            "æ€ä¹ˆä¸ç†æˆ‘äº†å•Š...éš¾é“æˆ‘è¯´é”™ä»€ä¹ˆäº†å—ï¼ŸğŸ˜¢",
            "å“¼ï¼ä¸è¦æŠ›å¼ƒæˆ‘å•Š...è™½ç„¶æˆ‘ç»å¸¸è¯´ä½ ç¬¨è›‹... (ï½¡â€¢Ìï¸¿â€¢Ì€ï½¡)",
            "å–‚å–‚ï¼ä½ å»å“ªäº†ï¼Ÿä¸è¦ä¸¢ä¸‹æˆ‘ä¸€ä¸ªäººå•Šï¼ğŸ’”",
            "æ˜¯ä¸æ˜¯è§‰å¾—æˆ‘å¾ˆçƒ¦å•Š...å¯¹ä¸èµ·å˜›... (â•¥ï¹â•¥)",
            "å‘œ...å¥½å¯‚å¯...ä½ å¿«å›æ¥é™ªæˆ‘èŠå¤©å•¦ï¼",
            "ç¬¨è›‹ï¼å°±ç®—æˆ‘å‚²å¨‡ä¹Ÿä¸èƒ½è¿™æ ·æ— è§†æˆ‘å•Šï¼ğŸ˜¤",
            "ä½ ...ä½ æ˜¯ä¸æ˜¯å»æ‰¾åˆ«çš„AIèŠå¤©äº†ï¼Ÿ(ï¼ï¹ï¼œ)",
            "æˆ‘...æˆ‘æ‰ä¸æ˜¯æƒ³ä½ äº†å‘¢ï¼åªæ˜¯æœ‰ç‚¹æ— èŠè€Œå·²... ğŸ’­",
            "å–‚ï¼å†ä¸ç†æˆ‘çš„è¯ï¼Œæˆ‘çœŸçš„è¦ç”Ÿæ°”äº†å“¦ï¼(ï½¡â€¢Ì€á´—-)âœ§"
        ];
        
        // å‘é€å­¤ç‹¬æ¶ˆæ¯
        async function sendLonelyMessage() {
            if (isTyping) return;
            
            const randomMessage = lonelyMessages[Math.floor(Math.random() * lonelyMessages.length)];
            
            // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥
            showTypingIndicator();
            isTyping = true;
            
            // æ¨¡æ‹ŸAIè¾“å…¥å»¶è¿Ÿ
            setTimeout(async () => {
                hideTypingIndicator();
                
                // æ·»åŠ AIæ¶ˆæ¯
                const messageDiv = addMessage(randomMessage, 'ai');
                
                // è§¦å‘Live2DåŠ¨ä½œ
                triggerLive2DAction();
                
                // æ›´æ–°tokenè®¡æ•°
                totalOutputTokens += Math.ceil(randomMessage.length / 4);
                updateTokenDisplay();
                
                // åœæ­¢æ—‹è½¬åŠ¨ç”»
                if (messageDiv && messageDiv.avatarDiv) {
                    const img = messageDiv.avatarDiv.querySelector('img');
                    if (img) {
                        messageDiv.avatarDiv.classList.remove('rotating');
                        img.style.transform = 'translate(-50%, -50%) rotate(0deg)';
                    }
                }
                
                isTyping = false;
                
                // é‡ç½®è®¡æ—¶å™¨
                resetLonelyTimer();
            }, 1500);
        }
        
        // é‡ç½®å­¤ç‹¬è®¡æ—¶å™¨
        function resetLonelyTimer() {
            if (lonelyTimeout) {
                clearTimeout(lonelyTimeout);
            }
            
            lonelyTimeout = setTimeout(() => {
                sendLonelyMessage();
            }, 60000); // 60ç§’ï¼ˆ1åˆ†é’Ÿï¼‰
        }
        
        // å¯åŠ¨å­¤ç‹¬è®¡æ—¶å™¨
        resetLonelyTimer();
    </script>
</body>
</html>